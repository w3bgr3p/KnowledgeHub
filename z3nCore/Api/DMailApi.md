# DMail

Класс для работы с почтовым сервисом DMail. Позволяет авторизоваться в системе, получать список писем, читать сообщения, отмечать их как прочитанные или перемещать в корзину.

## Конструкторы

### DMail(IZennoPosterProjectModel project, string key = null, bool log = false)

Создает новый экземпляр класса DMail.

**Параметры:**
- `project` - проект ZennoPoster
- `key` - приватный ключ кошелька (необязательно, может быть получен из базы данных проекта)
- `log` - включить логирование (по умолчанию false)

**Пример:**
```csharp
//создать экземпляр без логирования
var dmail = new DMail(project);

//создать экземпляр с логированием и указанным ключом
var dmail = new DMail(project, "your_private_key", true);
```

## Публичные методы

### CheckAuth() : void

Проверяет и устанавливает авторизацию в системе DMail. Автоматически пытается получить данные авторизации из переменных проекта или выполнить повторную авторизацию.

**Возвращаемое значение:** нет

**Описание:** Проверяет наличие токенов авторизации и при необходимости выполняет процедуру входа в систему.

**Пример:**
```csharp
var dmail = new DMail(project);
//проверить авторизацию
dmail.CheckAuth();
project.SendInfoToLog("Авторизация проверена");
```

### GetAll() : dynamic

Получает список всех писем из папки "Входящие".

**Возвращаемое значение:** динамический объект с массивом писем

**Описание:** Загружает первые 20 писем из папки входящих сообщений.

**Пример:**
```csharp
var dmail = new DMail(project);
//получить все письма
dynamic allMails = dmail.GetAll();
project.SendInfoToLog($"Получено писем: {allMails.Count}");
```

### ReadMsg(int index = 0, dynamic mail = null, bool markAsRead = true, bool trash = true) : Dictionary<string, string>

Читает конкретное письмо по индексу.

**Возвращаемое значение:** словарь с данными письма (отправитель, дата, тема, содержимое, идентификаторы)

**Описание:** Извлекает содержимое письма и опционально отмечает его как прочитанное или перемещает в корзину.

**Параметры:**
- `index` - индекс письма в списке (по умолчанию 0)
- `mail` - объект с письмами (если не указан, использует последний загруженный список)
- `markAsRead` - отметить как прочитанное (по умолчанию true)
- `trash` - переместить в корзину (по умолчанию true)

**Пример:**
```csharp
var dmail = new DMail(project);
dmail.GetAll();
//прочитать первое письмо без удаления
var message = dmail.ReadMsg(0, markAsRead: true, trash: false);
project.SendInfoToLog($"От: {message["sender"]}, Тема: {message["subj"]}");
```

### GetUnread(bool parse = false, string key = null) : string

Получает информацию о непрочитанных сообщениях.

**Возвращаемое значение:** JSON-строка с информацией или конкретное значение, если указан ключ

**Описание:** Возвращает статистику непрочитанных писем и использования почтового ящика.

**Параметры:**
- `parse` - парсировать ответ (по умолчанию false)
- `key` - конкретный ключ для извлечения ("mail_unread_count", "message_unread_count", "not_read_count", "used_total_size")

**Пример:**
```csharp
var dmail = new DMail(project);
//получить количество непрочитанных писем
string unreadCount = dmail.GetUnread(key: "mail_unread_count");
project.SendInfoToLog($"Непрочитанных писем: {unreadCount}");

//получить полную информацию
string fullInfo = dmail.GetUnread();
project.SendInfoToLog($"Полная статистика: {fullInfo}");
```

### Trash(int index = 0, string dm_scid = null, string dm_smid = null) : void

Перемещает письмо в корзину.

**Возвращаемое значение:** нет

**Описание:** Перемещает указанное письмо из папки "Входящие" в корзину.

**Параметры:**
- `index` - индекс письма (по умолчанию 0)
- `dm_scid` - идентификатор беседы (если не указан, получает автоматически)
- `dm_smid` - идентификатор сообщения (если не указан, получает автоматически)

**Пример:**
```csharp
var dmail = new DMail(project);
dmail.GetAll();
//переместить первое письмо в корзину
dmail.Trash(0);
project.SendInfoToLog("Письмо перемещено в корзину");
```

### MarkAsRead(int index = 0, string dm_scid = null, string dm_smid = null) : void

Отмечает письмо как прочитанное.

**Возвращаемое значение:** нет

**Описание:** Изменяет статус письма на "прочитано" без перемещения в корзину.

**Параметры:**
- `index` - индекс письма (по умолчанию 0)
- `dm_scid` - идентификатор беседы (если не указан, получает автоматически)
- `dm_smid` - идентификатор сообщения (если не указан, получает автоматически)

**Пример:**
```csharp
var dmail = new DMail(project);
dmail.GetAll();
//отметить первое письмо как прочитанное
dmail.MarkAsRead(0);
project.SendInfoToLog("Письмо отмечено как прочитанное");
```